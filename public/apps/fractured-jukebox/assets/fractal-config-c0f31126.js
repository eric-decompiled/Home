var it=Object.defineProperty;var ot=(m,i,e)=>i in m?it(m,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):m[i]=e;var M=(m,i,e)=>(ot(m,typeof i!="symbol"?i+"":i,e),e);import{T as j,s as Y,l as at}from"./index-af46b427.js";const st="fractal-user-presets";function nt(){try{const m=localStorage.getItem(st);return m?JSON.parse(m):[]}catch{return[]}}function Z(m){localStorage.setItem(st,JSON.stringify(m))}const k=500,rt=150,E=200,V=100,K=2048,W=["0","I","ii","iii","IV","V","vi","vii"],N=["#888","#ff4444","#44aaff","#44dd88","#ffaa22","#ff66cc","#88ccff","#ffff44"],G=["#ff6666","#66bbff","#66ff99","#ffcc44"],J=["1","2","3","4"],B=[{id:"major",label:""}],X={classic:{formula:"z ‚Üí z¬≤ + c",year:"1980",creator:"Benoit Mandelbrot",category:"Quadratic Polynomial",description:"The original Mandelbrot/Julia set - the most famous fractal in mathematics. Discovered while Mandelbrot was studying iterative functions at IBM. It exhibits infinite complexity at all scales and has become an icon of mathematical beauty and chaos theory.",traits:["Smooth, rounded bulbs","Cardioid main body","Infinite spiraling detail","Self-similar at all zoom levels","Connected interior"],hotspots:["c = -0.75 (period-2 bulb)","c = -0.12 + 0.74i (spiral)","c = 0.28 + 0.01i (dendrite)","c = -1.0 (basilica)"],tips:'The boundary between black and color contains all the interesting detail. Look for "mini-brots" - tiny copies of the full set hidden in the spirals.',related:["Tricorn","Multicorn-3","Burning Ship"]},"burning-ship":{formula:"z ‚Üí (|Re(z)| + i|Im(z)|)¬≤ + c",year:"1992",creator:"Michael Michelitsch & Otto R√∂ssler",category:"Absolute Value Variant",description:"Takes absolute values of real and imaginary parts before squaring, breaking the smooth symmetry of the classic set. The main structure resembles a burning ship with flames rising from its deck, hence the name. One of the most visually striking fractal variants.",traits:["Sharp angular edges","Asymmetric structure","Ship-like main body","Flame-like tendrils","Jagged coastlines"],hotspots:["c = -1.76 - 0.04i (ship hull)","c = -1.94 + 0.0i (flames)","c = -0.5 - 0.5i (spirals)"],tips:'The ship is upside down in standard orientation. Zoom into the "flames" rising from the mast for incredible detail. The antenna regions contain mini-ships.',related:["PerpBurn","Celtic","Buffalo"]},buffalo:{formula:"z ‚Üí |z|¬≤ - |z| + c",year:"~2000s",creator:"Fractal community",category:"Absolute Value Variant",description:"A hybrid formula that subtracts the absolute magnitude of z after squaring. Creates distinctive horn-like protrusions that give it a buffalo or ox-like appearance. Known for its organic, almost biological-looking structures.",traits:["Horn-like extensions","Organic asymmetry","Dense interior detail","Complex boundary","Biological appearance"],hotspots:["c = -0.5 + 0.5i (horns)","c = -1.0 + 0.0i (body)","c = 0.0 - 0.8i (tail)"],tips:'Look for the "horns" emerging from the main body. The interior contains dense, hair-like structures. Works well with warm color palettes.',related:["Burning Ship","Celtic","PerpBurn"]},celtic:{formula:"z ‚Üí |Re(z¬≤)| + i¬∑Im(z¬≤) + c",year:"~2000s",creator:"Fractal community",category:"Partial Absolute Value",description:"Applies absolute value only to the real component after squaring, creating intricate interlocking patterns reminiscent of Celtic knotwork and illuminated manuscripts. The partial symmetry-breaking creates a unique aesthetic.",traits:["Interlocking knots","Symmetric patterns","Dense filaments","Celtic cross motifs","Woven textures"],hotspots:["c = -0.4 + 0.6i (knots)","c = -0.8 + 0.16i (crosses)","c = -0.45 - 0.5i (weave)"],tips:'Celtic patterns emerge best near the boundary. The "crosses" form where four regions meet. Try zooming into areas where filaments interweave.',related:["Burning Ship","Buffalo","PerpBurn"]},phoenix:{formula:"z ‚Üí z¬≤ + c + p¬∑z‚Çã‚ÇÅ",year:"1988",creator:"Shigehiro Ushiki",category:"Memory-Based",description:"A unique fractal that incorporates memory - using the previous iteration's value weighted by parameter p (typically -0.5). This creates flowing, dynamic patterns with bird-like silhouettes. Named for the mythical phoenix due to its wing-like shapes.",traits:["Bird-like silhouettes","Memory effects","Feathered edges","Dynamic flow patterns","Wing structures"],hotspots:["c = 0.56 + 0.0i (classic phoenix)","c = -0.4 + 0.1i (feathers)","c = 0.3 - 0.3i (wings)"],tips:'The p parameter (memory weight) dramatically changes the character. At p = -0.5, bird shapes emerge. Watch how regions seem to "flow" into each other.',related:["Classic","Nova","Tricorn"]},tricorn:{formula:"z ‚Üí conj(z)¬≤ + c",year:"1989",creator:"W.D. Crowe et al.",category:"Conjugate Variant",description:'Also called the Mandelbar set. Uses the complex conjugate before squaring, which flips the imaginary axis each iteration. This breaks two-fold symmetry into three-fold, creating the distinctive three-pointed "tricorn" shape.',traits:["Three-fold symmetry","Tricorn shape","Spiky protrusions","Mirror-like reflections","Pinched bulbs"],hotspots:["c = -0.1 + 0.9i (spike tip)","c = -1.0 + 0.0i (period-2)","c = 0.3 + 0.5i (mini-tricorn)"],tips:'The three main "horns" each contain infinite detail. Look for mini-tricorns in the boundary regions. The Julia sets are often more symmetric than the locus.',related:["Classic","Multicorn-3","Buffalo"]},"perp-burn":{formula:"z ‚Üí (Re(z) + i|Im(z)|)¬≤ + c",year:"~2000s",creator:"Fractal community",category:"Partial Absolute Value",description:"The Perpendicular Burning Ship applies absolute value only to the imaginary component, creating a hybrid between classic and Burning Ship aesthetics. Has strong vertical symmetry with flame-like structures.",traits:["Vertical symmetry","Flame structures","Perpendicular cuts","Hybrid characteristics","Layered flames"],hotspots:["c = -1.75 + 0.0i (main flame)","c = -0.5 + 0.5i (side burns)","c = -1.0 - 0.3i (embers)"],tips:"Compare directly with Burning Ship to see how the partial absolute value changes the structure. The vertical axis is a mirror line.",related:["Burning Ship","Celtic","Buffalo"]},"newton-3":{formula:"z ‚Üí z - (z¬≥-1)/(3z¬≤)",year:"1879 (method) / 1983 (fractal)",creator:"Isaac Newton / John Hubbard",category:"Root-Finding",description:"Applies Newton's root-finding method to z¬≥ - 1 = 0, which has three cube roots of unity. Points are colored by which root they converge to, with boundaries showing chaotic behavior. Unlike escape-time fractals, this uses convergence.",traits:["Three-color basins","Fractal boundaries","Root convergence","No escape iteration","Basin interleaving"],hotspots:["Origin region (all three roots compete)","Unit circle (root boundaries)","z = 0 (critical point)"],tips:`This fractal doesn't use "escape" - instead colors show which root each point finds. The boundaries between basins are infinitely complex. c parameter is not used.`,related:["Nova","Magnet","Barnsley-1"]},nova:{formula:"z ‚Üí z - (z¬≥-1)/(3z¬≤) + c",year:"1997",creator:"Paul Derbyshire",category:"Newton Hybrid",description:"A creative fusion of Newton's method with Julia set iteration - adds a constant c after each Newton step. This creates parameterized Newton fractals where the c value controls basin shapes and interactions.",traits:["Parameterized Newton","Three attractors","Complex basins","Rich color mixing","Flowing boundaries"],hotspots:["c = 0.0 + 0.0i (pure Newton)","c = 1.0 + 0.0i (distorted basins)","c = 0.5 + 0.5i (swirling)"],tips:"The three roots create natural triadic harmonies - try placing anchors near each root. Small c values give cleaner patterns while larger values create more turbulent basins.",related:["Newton-3","Phoenix","Magnet"]},magnet:{formula:"z ‚Üí ((z¬≤ + c - 1)/(2z + c - 2))¬≤",year:"1994",creator:"Derived from physics",category:"Physics-Derived",description:'Emerges from renormalization group equations describing magnetic phase transitions in physics. Unlike other fractals, it has a single attractor at z = 1 rather than infinity. The "magnetic domains" show where different initial conditions flow.',traits:["Physics-derived","Single attractor at z=1","Magnetic domains","Phase boundaries","Convergent iteration"],hotspots:["c = 0.0 + 0.0i (centered)","c = 2.0 + 0.0i (boundary)","c = 1.0 + 1.0i (distorted)"],tips:'Points converge to z = 1 rather than escaping to infinity. The "domains" represent different convergence speeds. Has connections to real physical systems.',related:["Magnet-II","Newton-3","Nova","Classic"]},"magnet-2":{formula:"z ‚Üí ((z¬≥ + 3(c-1)z + (c-1)(c-2)) / (3z¬≤ + 3(c-2)z + (c-1)(c-2) + 1))¬≤",year:"1994",creator:"Derived from physics",category:"Physics-Derived",description:"The second Magnet fractal from statistical mechanics. Uses cubic terms in the iteration, creating more intricate flame-like boundaries than Type I. Both types model magnetic phase transitions via renormalization group equations.",traits:["Cubic iteration","Flame-like tendrils","Single attractor at z=1","More intricate than Type I","Physics-derived"],hotspots:["c = 0.0 + 0.0i (centered)","c = 1.5 + 0.0i (boundary)","c = 0.5 + 0.5i (swirling)"],tips:"More complex than Magnet I due to cubic terms. The flame-like boundaries are characteristic. Converges to z = 1 like Type I.",related:["Magnet-I","Newton-3","Nova"]},"barnsley-1":{formula:"z ‚Üí (z-1)c if Re(z)‚â•0, else (z+1)c",year:"1988",creator:"Michael Barnsley",category:"Conditional/IFS",description:"Michael Barnsley's conditional fractal uses different formulas based on the sign of the real part. Inspired by Iterated Function Systems (IFS), it creates fern-like, branching patterns similar to his famous Barnsley Fern.",traits:["Conditional iteration","Fern-like patterns","Branching structures","Asymmetric growth","Leaf-like shapes"],hotspots:["c = 0.38 + 0.62i (fern tips)","c = -0.15 + 0.78i (branches)","c = 0.52 + 0.25i (spirals)"],tips:"The conditional nature creates natural-looking branching. Look for fern fronds and leaf structures. Best viewed with green/nature color palettes.",related:["Barnsley-2","Barnsley-3","Celtic"]},"barnsley-2":{formula:"z ‚Üí (z¬±1)c based on Im(z¬∑c)",year:"1988",creator:"Michael Barnsley",category:"Conditional/IFS",description:"Barnsley's second variation changes the condition to depend on the product of z and c, creating different domain boundaries. Often produces more organic, flowing shapes than Barnsley-1.",traits:["Complex conditions","Organic shapes","Interleaved domains","Natural forms","Smooth boundaries"],hotspots:["c = 0.28 + 0.54i (organic)","c = -0.42 + 0.38i (interleaved)","c = 0.65 + 0.32i (flowing)"],tips:"The condition based on Im(z¬∑c) creates more complex domain boundaries. Look for regions where the two formulas compete.",related:["Barnsley-1","Barnsley-3","Phoenix"]},"barnsley-3":{formula:"z ‚Üí (z¬≤-1) + c¬∑(z+1) or (z¬≤-1) + c",year:"1988",creator:"Michael Barnsley",category:"Conditional/IFS",description:"The third Barnsley variant combines quadratic iteration with conditional c multiplication. Creates dense filament structures with multiple competing domains.",traits:["Quadratic hybrid","Dense filaments","Multiple domains","Complex dynamics","Hairlike structures"],hotspots:["c = 0.22 + 0.35i (filaments)","c = -0.55 + 0.12i (dense)","c = 0.18 - 0.48i (domains)"],tips:"The quadratic base gives familiar bulb shapes, but the conditional term adds chaos. Look for regions where filaments explode from bulb boundaries.",related:["Barnsley-1","Barnsley-2","Classic"]},"multicorn-3":{formula:"z ‚Üí conj(z)¬≥ + c",year:"1989+",creator:"Extension of Tricorn",category:"Higher-Order Conjugate",description:"A higher-order version of the Tricorn (Mandelbar) using the cube instead of square. The conjugate combined with odd power creates distinctive multi-fold symmetry with pointed lobes radiating from the center.",traits:["Multi-fold symmetry","Pointed lobes","Conjugate dynamics","Higher-order effects","Star-like shapes"],hotspots:["c = 0.0 + 0.8i (star tips)","c = -0.5 + 0.5i (lobes)","c = 0.3 - 0.3i (mini-corns)"],tips:"The odd power (3) with conjugate creates different symmetry than even powers. Look for star-like patterns with multiple arms. Each arm contains self-similar detail.",related:["Tricorn","Classic","Phoenix"]},mandelbrot:{formula:"z ‚Üí z¬≤ + c (c = pixel)",year:"1980 / Exploration Mode",creator:"Benoit Mandelbrot",category:"Parameter Space",description:'True Mandelbrot mode where c comes from the pixel position rather than being fixed. This shows the "parameter space" - each point represents a different Julia set. The z‚ÇÄ sliders let you explore perturbed Mandelbrot sets with non-zero starting values.',traits:["Parameter space view","Adjustable initial z‚ÇÄ","Classic iteration","Exploration mode","Julia set catalog"],hotspots:["z‚ÇÄ = 0 + 0i (classic)","z‚ÇÄ = 0.5 + 0i (perturbed)","z‚ÇÄ = 0 + 0.5i (imaginary shift)"],tips:"Each point in this view IS a Julia set. Black = connected Julia, colored = disconnected (Cantor dust). Adjust z‚ÇÄ sliders to see how initial conditions change the boundary.",related:["Classic (Julia mode)","Tricorn","Burning Ship"]}},T=[{id:"classic",label:"Classic",typeNum:0,bounds:{rMin:-2,rMax:.7,iMin:-1.3,iMax:1.3},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){const n=t*t,r=s*s;if(n+r>4)return c+1;s=2*t*s+i,t=n-r+m}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){const n=t*t,r=s*s;if(n+r>4)return c+1;s=2*t*s+o,t=n-r+e}return 0}},{id:"burning-ship",label:"Burning Ship",typeNum:3,bounds:{rMin:-2.2,rMax:1.2,iMin:-2,iMax:.8},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){const n=Math.abs(t),r=Math.abs(s);if(t=n*n-r*r+m,s=2*n*r+i,t*t+s*s>100)return c+1}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){const n=Math.abs(t),r=Math.abs(s);if(t=n*n-r*r+e,s=2*n*r+o,t*t+s*s>4)return c+1}return 0}},{id:"buffalo",label:"Buffalo",typeNum:9,bounds:{rMin:-1.6,rMax:1.4,iMin:-1.4,iMax:1.4},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){const n=Math.abs(t),r=Math.abs(s);if(t=n*n-r*r-n+m,s=2*n*r-r+i,t*t+s*s>100)return c+1}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){const n=Math.abs(t),r=Math.abs(s);if(t=n*n-r*r-n+e,s=2*n*r-r+o,t*t+s*s>4)return c+1}return 0}},{id:"celtic",label:"Celtic",typeNum:6,bounds:{rMin:-2.2,rMax:1.5,iMin:-1.6,iMax:1.6},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){const n=t*t,r=s*s,l=Math.abs(n-r)+m,d=2*t*s+i;if(t=l,s=d,t*t+s*s>100)return c+1}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){const n=t*t,r=s*s,l=Math.abs(n-r)+e,d=2*t*s+o;if(t=l,s=d,t*t+s*s>4)return c+1}return 0}},{id:"phoenix",label:"Phoenix",typeNum:5,bounds:{rMin:-2,rMax:1.5,iMin:-1.5,iMax:1.5},locus(m,i,e,o=0,a=0){let t=o,s=a,c=0,n=0;const r=-.5;for(let l=0;l<e;l++){const d=t*t-s*s+m+r*c,h=2*t*s+i+r*n;if(c=t,n=s,t=d,s=h,t*t+s*s>100)return l+1}return 0},julia(m,i,e,o,a){let t=m,s=i,c=0,n=0;const r=-.5;for(let l=0;l<a;l++){const d=t*t-s*s+e+r*c,h=2*t*s+o+r*n;if(c=t,n=s,t=d,s=h,t*t+s*s>4)return l+1}return 0}},{id:"tricorn",label:"Tricorn",typeNum:4,bounds:{rMin:-2.5,rMax:1.5,iMin:-1.8,iMax:1.8},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){const n=t*t-s*s+m,r=-2*t*s+i;if(t=n,s=r,t*t+s*s>100)return c+1}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){const n=t*t-s*s+e,r=-2*t*s+o;if(t=n,s=r,t*t+s*s>4)return c+1}return 0}},{id:"perp-burn",label:"PerpBurn",typeNum:8,bounds:{rMin:-2.2,rMax:1.2,iMin:-2,iMax:.8},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){const n=Math.abs(s),r=t*t-n*n+m,l=2*t*n+i;if(t=r,s=l,t*t+s*s>100)return c+1}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){const n=Math.abs(s),r=t*t-n*n+e,l=2*t*n+o;if(t=r,s=l,t*t+s*s>4)return c+1}return 0}},{id:"newton-3",label:"Newton-3",typeNum:10,bounds:{rMin:-2,rMax:2,iMin:-2,iMax:2},locus(m,i,e,o=0,a=0){let t=m+o,s=i+a;const c=[[1,0],[-.5,Math.sqrt(3)/2],[-.5,-Math.sqrt(3)/2]];for(let n=0;n<e;n++){const r=t*t+s*s;if(r<1e-10)return 0;const l=Math.sqrt(r),d=Math.atan2(s,t),h=l*l*l,f=h*Math.cos(3*d),u=h*Math.sin(3*d),y=3*r*Math.cos(2*d),b=3*r*Math.sin(2*d),p=f-1,g=u,v=y*y+b*b;if(v<1e-10)return 0;t=t-(p*y+g*b)/v,s=s-(g*y-p*b)/v;for(const[x,w]of c)if((t-x)**2+(s-w)**2<1e-4)return n+1}return 0},julia(m,i,e,o,a){return this.locus(m,i,a)}},{id:"nova",label:"Nova",typeNum:11,bounds:{rMin:-2,rMax:2,iMin:-2,iMax:2},locus(m,i,e,o=0,a=0){let t=m+o,s=i+a;const c=[[1,0],[-.5,.866025],[-.5,-.866025]];for(let n=0;n<e;n++){const r=t*t,l=s*s,d=r+l;if(d>100)return n+1;for(let S=0;S<3;S++){const C=t-c[S][0],R=s-c[S][1];if(C*C+R*R<1e-6)return(e-n)*.5+S*e*.15+1}if(d<1e-12)return e*.3;const h=r-l,f=2*t*s,u=t*h-s*f,y=t*f+s*h,b=3*h,p=3*f,g=b*b+p*p;if(g<1e-12)return e*.3;const v=u-1,x=y,w=(v*b+x*p)/g,I=(x*b-v*p)/g;t=t-w+m,s=s-I+i}return e*.5},julia(m,i,e,o,a){let t=m,s=i;const c=[[1,0],[-.5,.866025],[-.5,-.866025]];for(let n=0;n<a;n++){const r=t*t,l=s*s,d=r+l;if(d>100)return n+1;for(let S=0;S<3;S++){const C=t-c[S][0],R=s-c[S][1];if(C*C+R*R<1e-6)return(a-n)*.5+S*a*.15+1}if(d<1e-12)return a*.3;const h=r-l,f=2*t*s,u=t*h-s*f,y=t*f+s*h,b=3*h,p=3*f,g=b*b+p*p;if(g<1e-12)return a*.3;const v=u-1,x=y,w=(v*b+x*p)/g,I=(x*b-v*p)/g;t=t-w+e,s=s-I+o}return a*.5}},{id:"magnet",label:"Magnet-I",typeNum:13,bounds:{rMin:-3,rMax:3,iMin:-3,iMax:3},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){if((t-1)**2+s**2<1e-4||t*t+s*s>1e3)return c+1;const r=t*t-s*s+m-1,l=2*t*s+i,d=2*t+m-2,h=2*s+i,f=d*d+h*h;if(f<1e-10)return c+1;const u=(r*d+l*h)/f,y=(l*d-r*h)/f;t=u*u-y*y,s=2*u*y}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){if((t-1)**2+s**2<1e-4||t*t+s*s>1e3)return c+1;const r=t*t-s*s+e-1,l=2*t*s+o,d=2*t+e-2,h=2*s+o,f=d*d+h*h;if(f<1e-10)return c+1;const u=(r*d+l*h)/f,y=(l*d-r*h)/f;t=u*u-y*y,s=2*u*y}return 0}},{id:"magnet-2",label:"Magnet-II",typeNum:19,bounds:{rMin:-3,rMax:3,iMin:-3,iMax:3},locus(m,i,e,o=0,a=0){let t=o,s=a;const c=m-1,n=i,r=m-2,l=i,d=c*r-n*l,h=c*l+n*r;for(let f=0;f<e;f++){if((t-1)**2+s**2<1e-4||t*t+s*s>1e3)return f+1;const y=t*t,b=s*s,p=t*y-3*t*b,g=3*y*s-s*b,v=3*(c*t-n*s),x=3*(c*s+n*t),w=p+v+d,I=g+x+h,S=3*(y-b),C=6*t*s,R=3*(r*t-l*s),L=3*(r*s+l*t),D=S+R+d+1,q=C+L+h,A=D*D+q*q;if(A<1e-10)return f+1;const z=(w*D+I*q)/A,H=(I*D-w*q)/A;t=z*z-H*H,s=2*z*H}return 0},julia(m,i,e,o,a){let t=m,s=i;const c=e-1,n=o,r=e-2,l=o,d=c*r-n*l,h=c*l+n*r;for(let f=0;f<a;f++){if((t-1)**2+s**2<1e-4||t*t+s*s>1e3)return f+1;const y=t*t,b=s*s,p=t*y-3*t*b,g=3*y*s-s*b,v=3*(c*t-n*s),x=3*(c*s+n*t),w=p+v+d,I=g+x+h,S=3*(y-b),C=6*t*s,R=3*(r*t-l*s),L=3*(r*s+l*t),D=S+R+d+1,q=C+L+h,A=D*D+q*q;if(A<1e-10)return f+1;const z=(w*D+I*q)/A,H=(I*D-w*q)/A;t=z*z-H*H,s=2*z*H}return 0}},{id:"barnsley-1",label:"Barnsley-1",typeNum:14,bounds:{rMin:-2,rMax:2,iMin:-2,iMax:2},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){if(t*t+s*s>100)return c+1;const n=t>=0?t-1:t+1;t=n*m-s*i,s=n*i+s*m}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){if(t*t+s*s>100)return c+1;const n=t>=0?t-1:t+1;t=n*e-s*o,s=n*o+s*e}return 0}},{id:"barnsley-2",label:"Barnsley-2",typeNum:15,bounds:{rMin:-2,rMax:2,iMin:-2,iMax:2},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){if(t*t+s*s>100)return c+1;const r=t*i+s*m>=0?t-1:t+1;t=r*m-s*i,s=r*i+s*m}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){if(t*t+s*s>100)return c+1;const r=t*o+s*e>=0?t-1:t+1;t=r*e-s*o,s=r*o+s*e}return 0}},{id:"barnsley-3",label:"Barnsley-3",typeNum:16,bounds:{rMin:-2,rMax:2,iMin:-2,iMax:2},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){if(t*t+s*s>100)return c+1;const n=t*t-s*s-1,r=2*t*s;t>0?(t=n+m,s=r+i):(t=n+m*t+m,s=r+i*t+i)}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){if(t*t+s*s>100)return c+1;const n=t*t-s*s-1,r=2*t*s;t>0?(t=n+e,s=r+o):(t=n+e*t+e,s=r+o*t+o)}return 0}},{id:"multicorn-3",label:"Multicorn-3",typeNum:17,bounds:{rMin:-1.5,rMax:1.5,iMin:-1.5,iMax:1.5},locus(m,i,e,o=0,a=0){let t=o,s=a;for(let c=0;c<e;c++){if(t*t+s*s>100)return c+1;const n=Math.sqrt(t*t+s*s),r=Math.atan2(-s,t),l=n*n*n;t=l*Math.cos(3*r)+m,s=l*Math.sin(3*r)+i}return 0},julia(m,i,e,o,a){let t=m,s=i;for(let c=0;c<a;c++){if(t*t+s*s>100)return c+1;const n=Math.sqrt(t*t+s*s),r=Math.atan2(-s,t),l=n*n*n;t=l*Math.cos(3*r)+e,s=l*Math.sin(3*r)+o}return 0}}],U={};T.forEach((m,i)=>{U[m.typeNum]=i});const tt=[{name:"C",stops:[{pos:0,color:[4,0,3]},{pos:.15,color:[55,0,42]},{pos:.4,color:[170,20,130]},{pos:.65,color:[220,60,175]},{pos:.85,color:[240,120,200]},{pos:1,color:[200,80,165]}]},{name:"C#",stops:[{pos:0,color:[3,0,8]},{pos:.15,color:[35,0,55]},{pos:.4,color:[110,20,175]},{pos:.65,color:[160,60,220]},{pos:.85,color:[185,110,235]},{pos:1,color:[145,70,195]}]},{name:"D",stops:[{pos:0,color:[1,0,10]},{pos:.15,color:[18,4,65]},{pos:.4,color:[65,30,175]},{pos:.65,color:[110,70,220]},{pos:.85,color:[150,120,240]},{pos:1,color:[110,80,200]}]},{name:"D#",stops:[{pos:0,color:[0,0,10]},{pos:.15,color:[10,8,65]},{pos:.4,color:[40,40,180]},{pos:.65,color:[80,90,220]},{pos:.85,color:[120,140,240]},{pos:1,color:[80,100,200]}]},{name:"E",stops:[{pos:0,color:[0,4,20]},{pos:.15,color:[0,28,80]},{pos:.4,color:[0,95,170]},{pos:.65,color:[30,155,230]},{pos:.85,color:[70,190,245]},{pos:1,color:[30,140,200]}]},{name:"F",stops:[{pos:0,color:[0,3,8]},{pos:.15,color:[0,30,55]},{pos:.4,color:[0,120,150]},{pos:.65,color:[30,180,200]},{pos:.85,color:[80,210,225]},{pos:1,color:[40,170,185]}]},{name:"F#",stops:[{pos:0,color:[0,4,3]},{pos:.15,color:[0,38,30]},{pos:.4,color:[10,150,115]},{pos:.65,color:[40,200,155]},{pos:.85,color:[90,230,185]},{pos:1,color:[50,185,145]}]},{name:"G",stops:[{pos:0,color:[0,0,0]},{pos:.15,color:[0,24,16]},{pos:.4,color:[15,160,120]},{pos:.65,color:[50,210,165]},{pos:.85,color:[95,240,195]},{pos:1,color:[55,195,155]}]},{name:"G#",stops:[{pos:0,color:[3,2,0]},{pos:.15,color:[50,35,0]},{pos:.4,color:[175,135,0]},{pos:.65,color:[230,190,20]},{pos:.85,color:[250,215,50]},{pos:1,color:[210,170,15]}]},{name:"A",stops:[{pos:0,color:[0,0,0]},{pos:.15,color:[75,0,0]},{pos:.35,color:[190,35,0]},{pos:.55,color:[240,120,10]},{pos:.75,color:[255,190,40]},{pos:.9,color:[245,160,25]},{pos:1,color:[200,100,5]}]},{name:"A#",stops:[{pos:0,color:[5,0,1]},{pos:.15,color:[58,0,22]},{pos:.4,color:[190,30,80]},{pos:.65,color:[235,70,130]},{pos:.85,color:[245,130,175]},{pos:1,color:[205,80,135]}]},{name:"B",stops:[{pos:0,color:[5,0,3]},{pos:.15,color:[50,0,35]},{pos:.4,color:[170,15,110]},{pos:.65,color:[215,55,160]},{pos:.85,color:[235,110,195]},{pos:1,color:[195,65,155]}]}],_=.08,F=1,O=0,$=Math.PI/2,Q=[{type:4,real:.1691,imag:-.4957,orbitRadius:.15},{type:4,real:.1691,imag:-.4957,orbitRadius:.15},{type:8,real:.3215,imag:.3842,orbitRadius:.08},{type:3,real:.3386,imag:-1.5682,orbitRadius:.35},{type:6,real:-1.281,imag:-.4794,orbitRadius:.3},{type:4,real:.3789,imag:.5193,orbitRadius:.06},{type:3,real:-1.0169,imag:-1.0135,orbitRadius:.25},{type:9,real:-.5409,imag:-.9587,orbitRadius:.28}],P=class P{constructor(){M(this,"container");M(this,"visible",!1);M(this,"selectedDegree",1);M(this,"selectedQuality","major");M(this,"selectedFamily",0);M(this,"anchors",new Map);M(this,"locusCanvas");M(this,"locusCtx");M(this,"locusBuffer");M(this,"juliaCanvas");M(this,"juliaCtx");M(this,"viewBounds",[]);M(this,"zoomLevels",[]);M(this,"paletteLUT",new Uint8Array(K*3));M(this,"paletteIdx",4);M(this,"previewAnim",null);M(this,"previewPhase",0);M(this,"previewLastTime",0);M(this,"previewBpm",120);M(this,"previewScale",1);M(this,"dragMode",null);M(this,"dragDeg",-1);M(this,"dragStartMx",0);M(this,"dragStartMy",0);M(this,"dragStartData",{});M(this,"isDragging",!1);M(this,"snapMode","none");M(this,"showAtlasGrid",!1);M(this,"dragDebounceTimer",null);M(this,"touchStartPos",null);M(this,"longPressTimer",null);M(this,"modifierActive",!1);M(this,"thumbnailCache",new Map);M(this,"locusCache",new Map);M(this,"zoomDebounceTimer",null);M(this,"renderedBounds",[]);M(this,"thumbnailDebounceTimer",null);M(this,"onSave",null);M(this,"onPresetsChange",null);M(this,"userPresets",[]);M(this,"selectedPresetId",null);M(this,"hotspotIndices",new Map);this.userPresets=nt(),this.container=document.createElement("div"),this.container.className="fractal-config-overlay",this.container.innerHTML=this.buildHTML(),document.body.appendChild(this.container),this.locusCanvas=this.container.querySelector("#fc-locus-canvas"),this.locusCtx=this.locusCanvas.getContext("2d"),this.locusBuffer=document.createElement("canvas"),this.locusBuffer.width=k,this.locusBuffer.height=k,this.juliaCanvas=this.container.querySelector("#fc-julia-canvas"),this.juliaCtx=this.juliaCanvas.getContext("2d");for(const i of T)this.viewBounds.push({...i.bounds}),this.renderedBounds.push({...i.bounds}),this.zoomLevels.push(1);this.buildPaletteLUT(),this.loadAnchors(),this.setupEventHandlers()}getPresets(){return this.userPresets}getSelectedPresetId(){return this.selectedPresetId}selectPreset(i){this.selectedPresetId=i,this.loadPreset(i),this.updatePresetsUI()}parseHotspot(i){const e=i.match(/=\s*([-\d.]+)\s*([+-]\s*([\d.]+)i)?/);if(!e)return null;const o=parseFloat(e[1]);let a=0;if(e[2]){const t=e[2].replace(/\s/g,"").replace("i","");a=parseFloat(t)}return{real:o,imag:a}}cycleHotspot(i){const e=T[this.selectedFamily],o=X[e.id],a=(o==null?void 0:o.hotspots)||[];if(a.length===0)return;const s=((this.hotspotIndices.get(i)??-1)+1)%a.length;this.hotspotIndices.set(i,s);const c=this.parseHotspot(a[s]);if(!c)return;const n=this.anchorKey(i),r=this.anchors.get(n);r&&(r.real=c.real,r.imag=c.imag,r.familyIdx=this.selectedFamily,this.debouncedThumbnailUpdate());const l=this.container.querySelector("#fc-status");l.textContent=`${W[i]} ‚Üí ${a[s]}`,this.selectDegreeQuality(i,"major"),this.drawOverlay(),this.onSave&&this.onSave()}setOrbitRadius(i,e){const o=this.anchorKey(i),a=this.anchors.get(o);a&&(a.orbitRadius=Math.max(.01,e),this.drawOverlay())}setOrbitSkew(i,e){const o=this.anchorKey(i),a=this.anchors.get(o);a&&(a.orbitSkew=e,this.drawOverlay())}setOrbitRotation(i,e){const o=this.anchorKey(i),a=this.anchors.get(o);a&&(a.orbitRotation=e,this.drawOverlay())}setBeatSpread(i,e){const o=this.anchorKey(i),a=this.anchors.get(o);a&&(a.beatSpread=e,this.drawOverlay())}showFamilyInfo(){const i=T[this.selectedFamily],e=X[i.id],o=this.container.querySelector("#fc-info-modal");this.container.querySelector("#fc-info-title").textContent=i.label,this.container.querySelector("#fc-info-formula").textContent=(e==null?void 0:e.formula)||"z ‚Üí z¬≤ + c",this.container.querySelector("#fc-info-desc").textContent=(e==null?void 0:e.description)||"No description available.",this.container.querySelector("#fc-info-year").textContent=(e==null?void 0:e.year)||"Unknown",this.container.querySelector("#fc-info-creator").textContent=(e==null?void 0:e.creator)||"Unknown",this.container.querySelector("#fc-info-category").textContent=(e==null?void 0:e.category)||"Fractal",this.container.querySelector("#fc-info-traits-list").innerHTML=((e==null?void 0:e.traits)||[]).map(a=>`<li>${a}</li>`).join(""),this.container.querySelector("#fc-info-hotspots-list").innerHTML=((e==null?void 0:e.hotspots)||[]).map(a=>`<li><code>${a}</code></li>`).join(""),this.container.querySelector("#fc-info-tips-text").textContent=(e==null?void 0:e.tips)||"Explore the boundary regions for the most detail.",this.container.querySelector("#fc-info-related-list").innerHTML=((e==null?void 0:e.related)||[]).map(a=>`<span class="fc-info-related-tag">${a}</span>`).join(""),o.classList.add("visible")}hideFamilyInfo(){this.container.querySelector("#fc-info-modal").classList.remove("visible")}showControls(){this.container.querySelector("#fc-controls-modal").classList.add("visible")}hideControls(){this.container.querySelector("#fc-controls-modal").classList.remove("visible")}updateFamilyUI(){this.container.querySelectorAll(".fc-family-btn").forEach((e,o)=>{e.classList.toggle("active",o===this.selectedFamily)})}handleMapControl(i){const e=this.viewBounds[this.selectedFamily],o=e.rMax-e.rMin,a=e.iMax-e.iMin,t=.2;switch(i){case"pan-left":e.rMin-=o*t,e.rMax-=o*t;break;case"pan-right":e.rMin+=o*t,e.rMax+=o*t;break;case"pan-up":e.iMin-=a*t,e.iMax-=a*t;break;case"pan-down":e.iMin+=a*t,e.iMax+=a*t;break;case"zoom-in":{const s=(e.rMin+e.rMax)/2,c=(e.iMin+e.iMax)/2,n=.7;e.rMin=s-o*n/2,e.rMax=s+o*n/2,e.iMin=c-a*n/2,e.iMax=c+a*n/2;const r=T[this.selectedFamily].bounds;this.zoomLevels[this.selectedFamily]=(r.rMax-r.rMin)/(e.rMax-e.rMin);break}case"zoom-out":{const s=(e.rMin+e.rMax)/2,c=(e.iMin+e.iMax)/2,n=1.4;e.rMin=s-o*n/2,e.rMax=s+o*n/2,e.iMin=c-a*n/2,e.iMax=c+a*n/2;const r=T[this.selectedFamily].bounds;this.zoomLevels[this.selectedFamily]=(r.rMax-r.rMin)/(e.rMax-e.rMin);break}case"reset-view":this.viewBounds[this.selectedFamily]={...T[this.selectedFamily].bounds},this.zoomLevels[this.selectedFamily]=1;break}this.renderLocus(),this.drawOverlay()}syncOrbitSliders(){for(let i=0;i<=7;i++){const e=this.anchorKey(i),o=this.anchors.get(e);if(!o)continue;const a=this.container.querySelector(`.fc-radius-slider[data-deg="${i}"]`),t=this.container.querySelector(`.fc-skew-slider[data-deg="${i}"]`),s=this.container.querySelector(`.fc-rotation-slider[data-deg="${i}"]`),c=this.container.querySelector(`.fc-spread-slider[data-deg="${i}"]`);a&&(a.value=String(Math.round(o.orbitRadius*250))),t&&(t.value=String(Math.round(o.orbitSkew*100)));let n=o.orbitRotation%j;n<0&&(n+=j),s&&(s.value=String(Math.round(n*100))),c&&(c.value=String(Math.round(o.beatSpread*100)))}}anchorKey(i,e){return`${i}-major`}get currentKey(){return this.anchorKey(this.selectedDegree)}get currentAnchor(){return this.anchors.get(this.currentKey)}renderPresetsList(){let e=`
      <label class="fc-preset-option fc-preset-default">
        <input type="radio" name="fc-preset" value="" ${this.selectedPresetId===null?"checked":""}>
        <span class="fc-preset-radio"></span>
        <span class="fc-preset-name">Default</span>
      </label>
    `;for(const o of this.userPresets){const a=this.selectedPresetId===o.id?"checked":"";e+=`
        <label class="fc-preset-option fc-preset-user">
          <input type="radio" name="fc-preset" value="${o.id}" ${a}>
          <span class="fc-preset-radio"></span>
          <span class="fc-preset-name">${o.name}</span>
          <button class="fc-preset-delete" data-id="${o.id}" title="Delete preset">&times;</button>
        </label>
      `}return e}updatePresetsUI(){const i=this.container.querySelector(".fc-presets-bar"),e=this.container.querySelector(".fc-presets-list");i&&(i.style.display=this.userPresets.length===0?"none":""),e&&(e.innerHTML=this.renderPresetsList(),this.setupPresetHandlers())}setupPresetHandlers(){this.container.querySelectorAll('.fc-preset-option input[type="radio"]').forEach(i=>{i.addEventListener("change",e=>{const o=e.target.value;this.selectedPresetId=o||null,this.loadPreset(this.selectedPresetId)})}),this.container.querySelectorAll(".fc-preset-delete").forEach(i=>{i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const o=e.target.dataset.id;o&&this.deletePreset(o)})})}loadPreset(i){if(i===null)this.loadDefaultAnchors();else{const a=this.userPresets.find(t=>t.id===i);a&&this.loadAnchorsFromData(a.anchors)}this.fitViewToAnchors(),this.markAllThumbnailsDirty(),this.renderLocus(),this.drawOverlay(),this.updateAssignments(),this.updateResetButtonState();const e=this.getCurrentAnchorsData();Y(e),this.onSave&&this.onSave();const o=this.container.querySelector("#fc-status");o.textContent=i?"Preset loaded":"Default loaded"}fitViewToAnchors(){const i=[];for(const[,u]of this.anchors)u.familyIdx===this.selectedFamily&&i.push({real:u.real,imag:u.imag});if(i.length===0){this.viewBounds[this.selectedFamily]={...T[this.selectedFamily].bounds},this.renderedBounds[this.selectedFamily]={...T[this.selectedFamily].bounds},this.zoomLevels[this.selectedFamily]=1;return}let e=1/0,o=-1/0,a=1/0,t=-1/0;for(const u of i)e=Math.min(e,u.real),o=Math.max(o,u.real),a=Math.min(a,u.imag),t=Math.max(t,u.imag);const s=o-e||.5,c=t-a||.5,n=Math.max(s,c)*.3;e-=n,o+=n,a-=n,t+=n;const r=o-e,l=t-a;if(r>l){const u=(r-l)/2;a-=u,t+=u}else{const u=(l-r)/2;e-=u,o+=u}this.viewBounds[this.selectedFamily]={rMin:e,rMax:o,iMin:a,iMax:t},this.renderedBounds[this.selectedFamily]={rMin:e,rMax:o,iMin:a,iMax:t};const d=T[this.selectedFamily].bounds,h=d.rMax-d.rMin,f=o-e;this.zoomLevels[this.selectedFamily]=h/f}loadAnchorsFromData(i){this.anchors.clear();for(let e=0;e<=7;e++){const o=i[e];let a;if(o)a={familyIdx:U[o.type]??0,real:o.real,imag:o.imag,orbitRadius:o.orbitRadius??_,orbitSkew:o.orbitSkew??F,orbitRotation:o.orbitRotation??O,beatSpread:o.beatSpread??$};else{const t=Q[e];a={familyIdx:U[t.type],real:t.real,imag:t.imag,orbitRadius:t.orbitRadius,orbitSkew:t.orbitSkew??F,orbitRotation:t.orbitRotation??O,beatSpread:t.beatSpread??$}}for(const t of B)this.anchors.set(this.anchorKey(e,t.id),{...a})}}loadDefaultAnchors(){this.anchors.clear();for(let i=0;i<=7;i++){const e=Q[i],a={familyIdx:U[e.type],real:e.real,imag:e.imag,orbitRadius:e.orbitRadius,orbitSkew:e.orbitSkew??F,orbitRotation:e.orbitRotation??O,beatSpread:e.beatSpread??$};for(const t of B)this.anchors.set(this.anchorKey(i,t.id),{...a})}}deletePreset(i){this.userPresets=this.userPresets.filter(o=>o.id!==i),Z(this.userPresets),this.selectedPresetId===i&&(this.selectedPresetId=null,this.loadPreset(null)),this.updatePresetsUI(),this.onPresetsChange&&this.onPresetsChange();const e=this.container.querySelector("#fc-status");e.textContent="Preset deleted"}promptSavePreset(){const i=prompt("Enter preset name:");if(!i||!i.trim())return;const e=this.getCurrentAnchorsData(),o={id:Date.now().toString(),name:i.trim(),anchors:e,createdAt:Date.now()};this.userPresets.push(o),Z(this.userPresets),this.selectedPresetId=o.id,this.updatePresetsUI(),this.onPresetsChange&&this.onPresetsChange(),Y(e),this.onSave&&this.onSave();const a=this.container.querySelector("#fc-status");a.textContent=`Saved as "${o.name}"`}getCurrentAnchorsData(){const i={};for(let e=0;e<=7;e++){const o=this.anchorKey(e,"major"),a=this.anchors.get(o);if(!a)continue;const t=T[a.familyIdx];i[e]={real:a.real,imag:a.imag,type:t.typeNum,orbitRadius:a.orbitRadius,orbitSkew:a.orbitSkew,orbitRotation:a.orbitRotation,beatSpread:a.beatSpread}}return i}buildHTML(){const i=[[1,2,3,4,5,6,7]],e=t=>{const s=W[t];return`
        <div class="fc-degree-block">
          <div class="fc-degree-main">
            <div class="fc-degree-cells">
              ${B.map(n=>`<button class="fc-grid-cell${t===1&&n.id==="major"?" active":""}"
          data-deg="${t}" data-quality="${n.id}">
          <span class="fc-cell-dot" style="background:${N[t]}"></span>
        </button>`).join("")}
            </div>
            <div class="fc-degree-footer">
              <button class="fc-hotspot-btn" data-deg="${t}" title="Cycle through areas of interest">!</button>
              <div class="fc-grid-degree" data-deg="${t}" title="Apply to all qualities">
                <span class="fc-deg-dot" style="background:${N[t]}"></span>${s}
              </div>
            </div>
          </div>
          <div class="fc-orbit-controls">
            <label title="Orbit radius">‚äï<input type="range" class="fc-radius-slider" data-deg="${t}" min="1" max="100" value="20"></label>
            <label title="Orbit rotation">‚Üª<input type="range" class="fc-rotation-slider" data-deg="${t}" min="0" max="628" value="0"></label>
            <label title="Orbit skew (aspect ratio)">‚¨≠<input type="range" class="fc-skew-slider" data-deg="${t}" min="20" max="200" value="100"></label>
            <label title="Beat spread (angle between points)">‚à¢<input type="range" class="fc-spread-slider" data-deg="${t}" min="10" max="200" value="157"></label>
          </div>
        </div>`},o=i.map(t=>`<div class="fc-grid-row">${t.map(e).join("")}</div>`).join(""),a=tt.map((t,s)=>{const n=t.stops[Math.floor(t.stops.length*.6)].color;return`<div class="fc-palette-btn${s===this.paletteIdx?" active":""}"
        data-idx="${s}" title="${t.name}"
        style="background:rgb(${n[0]},${n[1]},${n[2]})"></div>`}).join("");return`
      <div class="fc-panel">
        <div class="fc-header">
          <h2>Fractal Config</h2>
          <button class="fc-close-btn">&times;</button>
        </div>

        <div class="fc-toolbar">
          <div class="fc-toolbar-section fc-description">
            <span class="fc-help-text">Click the preview to set anchor points. Each chord degree dances around its anchor during playback.</span>
          </div>
          <div class="fc-toolbar-divider"></div>
          <div class="fc-actions">
            <button class="fc-btn fc-save-btn">Save</button>
            <button class="fc-btn fc-reset-btn">Reset</button>
            <button class="fc-btn fc-copy-btn" title="Copy anchors as code">üìã</button>
          </div>
        </div>

        <div class="fc-presets-bar"${this.userPresets.length===0?' style="display:none"':""}>
          <span class="fc-presets-label">Presets:</span>
          <div class="fc-presets-list">
            ${this.renderPresetsList()}
          </div>
        </div>

        <div class="fc-family-bar">
          ${T.map((t,s)=>`<button class="fc-family-btn${s===0?" active":""}" data-family="${s}">${t.label}</button>`).join("")}
          <label class="fc-atlas-toggle" title="Toggle atlas grid overlay">
            <span class="fc-atlas-label">Atlas</span>
            <input type="checkbox" class="fc-atlas-checkbox">
            <span class="fc-atlas-switch"></span>
          </label>
          <button class="fc-btn fc-info-btn" title="Family information">‚ÑπÔ∏è</button>
        </div>

        <div class="fc-section fc-degree-section">
          <button class="fc-section-toggle" data-section="degrees">
            <span class="fc-section-icon">‚ñº</span>
            <span>Degrees</span>
          </button>
          <div class="fc-section-content fc-degree-grid">
            ${o}
          </div>
        </div>

        <div class="fc-content-area">
          <div class="fc-section fc-map-section">
            <button class="fc-section-toggle" data-section="map">
              <span class="fc-section-icon">‚ñº</span>
              <span>Map</span>
            </button>
            <div class="fc-section-content">
              <div class="fc-locus-wrap">
                <canvas id="fc-locus-canvas" width="${k}" height="${k}"></canvas>
                <div class="fc-map-controls">
                  <div class="fc-map-row">
                    <button class="fc-help-btn" title="Show controls">?</button>
                    <button class="fc-map-btn" data-action="pan-up" title="Pan up">‚Üë</button>
                    <button class="fc-map-btn" data-action="zoom-in" title="Zoom in">+</button>
                  </div>
                  <div class="fc-map-row">
                    <button class="fc-map-btn" data-action="pan-left" title="Pan left">‚Üê</button>
                    <button class="fc-map-btn" data-action="reset-view" title="Reset view">‚ü≤</button>
                    <button class="fc-map-btn" data-action="pan-right" title="Pan right">‚Üí</button>
                  </div>
                  <div class="fc-map-row">
                    <button class="fc-map-btn fc-map-empty"></button>
                    <button class="fc-map-btn" data-action="pan-down" title="Pan down">‚Üì</button>
                    <button class="fc-map-btn" data-action="zoom-out" title="Zoom out">‚àí</button>
                  </div>
                </div>
                <div class="fc-mobile-controls">
                  <button class="fc-modifier-btn" title="Toggle modifier (tap to place, drag to adjust skew)">
                    <span class="fc-modifier-icon">‚åò</span>
                    <span class="fc-modifier-label">Mod</span>
                  </button>
                </div>
                <div class="fc-locus-status" id="fc-status">Tap anchor to select</div>
              </div>
            </div>
          </div>

          <div class="fc-section fc-preview-section">
            <button class="fc-section-toggle" data-section="preview">
              <span class="fc-section-icon">‚ñº</span>
              <span>Preview</span>
            </button>
            <div class="fc-section-content">
              <div class="fc-preview-wrap">
                <div class="fc-preview-header">
                  <span>Preview</span>
                  <div class="fc-bpm-control">
                    <span class="fc-bpm-label">BPM</span>
                    <button class="fc-bpm-btn fc-bpm-down">‚ñº</button>
                    <input type="number" id="fc-bpm" value="120" min="30" max="300" step="5">
                    <button class="fc-bpm-btn fc-bpm-up">‚ñ≤</button>
                  </div>
                </div>
                <canvas id="fc-julia-canvas" width="${E}" height="${E}"></canvas>
                <div class="fc-julia-info" id="fc-julia-info">Select an anchor to preview</div>
                <div class="fc-preview-range">
                  <span>‚è∏</span>
                  <input type="range" id="fc-preview-scale" min="0" max="200" value="100" title="Preview movement range">
                  <span>üîÑ</span>
                </div>
                <div class="fc-palette-bar">${a}</div>

                <div class="fc-assignments" id="fc-assignments"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="fc-info-modal" id="fc-info-modal">
          <div class="fc-info-content">
            <div class="fc-info-header">
              <h3 id="fc-info-title">Family Name</h3>
              <button class="fc-info-close">&times;</button>
            </div>

            <div class="fc-info-meta">
              <span class="fc-info-meta-item"><strong>Year:</strong> <span id="fc-info-year">1980</span></span>
              <span class="fc-info-meta-item"><strong>Creator:</strong> <span id="fc-info-creator">Unknown</span></span>
              <span class="fc-info-meta-item"><strong>Category:</strong> <span id="fc-info-category">Polynomial</span></span>
            </div>

            <div class="fc-info-formula" id="fc-info-formula">z ‚Üí z¬≤ + c</div>

            <p class="fc-info-desc" id="fc-info-desc">Description</p>

            <div class="fc-info-section">
              <strong>Visual Characteristics:</strong>
              <ul id="fc-info-traits-list"></ul>
            </div>

            <div class="fc-info-section">
              <strong>Interesting c-values to explore:</strong>
              <ul id="fc-info-hotspots-list" class="fc-info-hotspots"></ul>
            </div>

            <div class="fc-info-tips">
              <strong>üí° Tips:</strong>
              <p id="fc-info-tips-text">Exploration tips will appear here.</p>
            </div>

            <div class="fc-info-related">
              <strong>Related Families:</strong>
              <span id="fc-info-related-list"></span>
            </div>
          </div>
        </div>

        <div class="fc-controls-modal" id="fc-controls-modal">
          <div class="fc-controls-content">
            <div class="fc-controls-header">
              <h3>Map Controls</h3>
              <button class="fc-controls-close">&times;</button>
            </div>
            <div class="fc-controls-list">
              <div class="fc-control-item">
                <span class="fc-control-key">Click</span>
                <span class="fc-control-desc">Place/move anchor for selected degree</span>
              </div>
              <div class="fc-control-item">
                <span class="fc-control-key">Drag anchor</span>
                <span class="fc-control-desc">Reposition anchor point</span>
              </div>
              <div class="fc-control-item">
                <span class="fc-control-key">Shift + Drag</span>
                <span class="fc-control-desc">Snap to horizontal/vertical axis</span>
              </div>
              <div class="fc-control-item">
                <span class="fc-control-key">${navigator.platform.includes("Mac")?"‚åò":"Ctrl"} + Click</span>
                <span class="fc-control-desc">Place anchor with current family</span>
              </div>
              <div class="fc-control-item">
                <span class="fc-control-key">Scroll wheel</span>
                <span class="fc-control-desc">Zoom in/out</span>
              </div>
              <div class="fc-control-item">
                <span class="fc-control-key">Middle-drag / Alt + Drag</span>
                <span class="fc-control-desc">Pan the view</span>
              </div>
              <div class="fc-control-item">
                <span class="fc-control-key">Double-click</span>
                <span class="fc-control-desc">Reset zoom to default</span>
              </div>
              <div class="fc-control-item">
                <span class="fc-control-key">Drag orbit handle</span>
                <span class="fc-control-desc">Adjust orbit radius</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    `}setupEventHandlers(){this.container.querySelector(".fc-close-btn").addEventListener("click",()=>this.hide()),this.container.querySelectorAll(".fc-section-toggle").forEach(d=>{d.addEventListener("click",()=>{const h=d.closest(".fc-section");if(h){h.classList.toggle("collapsed");const f=d.querySelector(".fc-section-icon");f&&(f.textContent=h.classList.contains("collapsed")?"‚ñ∂":"‚ñº")}})});const i=this.container.querySelectorAll(".fc-family-btn"),e=this.container.querySelector(".fc-info-btn");i.forEach(d=>{d.addEventListener("click",()=>{i.forEach(h=>h.classList.remove("active")),d.classList.add("active"),this.selectedFamily=parseInt(d.dataset.family),this.renderLocus(),this.drawOverlay(),this.updateAssignments(),e.classList.remove("pulse"),e.offsetWidth,e.classList.add("pulse")})}),this.container.addEventListener("click",d=>{d.target===this.container&&this.hide()}),this.container.querySelector(".fc-info-btn").addEventListener("click",()=>this.showFamilyInfo()),this.container.querySelector(".fc-info-close").addEventListener("click",()=>this.hideFamilyInfo()),this.container.querySelector("#fc-info-modal").addEventListener("click",d=>{d.target.classList.contains("fc-info-modal")&&this.hideFamilyInfo()}),document.addEventListener("keydown",d=>{if(d.key==="Escape"){const h=this.container.querySelector("#fc-info-modal"),f=this.container.querySelector("#fc-controls-modal");h.classList.contains("visible")&&this.hideFamilyInfo(),f.classList.contains("visible")&&this.hideControls()}}),this.container.querySelector(".fc-help-btn").addEventListener("click",()=>this.showControls()),this.container.querySelector(".fc-controls-close").addEventListener("click",()=>this.hideControls()),this.container.querySelector("#fc-controls-modal").addEventListener("click",d=>{d.target.classList.contains("fc-controls-modal")&&this.hideControls()}),this.container.querySelectorAll(".fc-map-btn").forEach(d=>{d.addEventListener("click",()=>{const h=d.dataset.action;this.handleMapControl(h)})}),this.container.querySelectorAll(".fc-grid-cell").forEach(d=>{d.addEventListener("click",()=>{const h=d,f=parseInt(h.dataset.deg),u=h.dataset.quality;this.selectDegreeQuality(f,u)})}),this.container.querySelectorAll(".fc-grid-degree").forEach(d=>{d.addEventListener("click",()=>{const h=parseInt(d.dataset.deg);this.applyToAllQualities(h)})}),this.container.querySelectorAll(".fc-hotspot-btn").forEach(d=>{d.addEventListener("click",()=>{const h=parseInt(d.dataset.deg);this.cycleHotspot(h)})}),this.container.querySelectorAll(".fc-radius-slider").forEach(d=>{d.addEventListener("input",()=>{const h=d,f=parseInt(h.dataset.deg),u=parseInt(h.value)/250;this.setOrbitRadius(f,u)})}),this.container.querySelectorAll(".fc-skew-slider").forEach(d=>{d.addEventListener("input",()=>{const h=d,f=parseInt(h.dataset.deg),u=parseInt(h.value)/100;this.setOrbitSkew(f,u)})}),this.container.querySelectorAll(".fc-rotation-slider").forEach(d=>{d.addEventListener("input",()=>{const h=d,f=parseInt(h.dataset.deg),u=parseInt(h.value)/100;this.setOrbitRotation(f,u)})}),this.container.querySelectorAll(".fc-spread-slider").forEach(d=>{d.addEventListener("input",()=>{const h=d,f=parseInt(h.dataset.deg),u=parseInt(h.value)/100;this.setBeatSpread(f,u)})}),this.container.querySelector(".fc-atlas-checkbox").addEventListener("change",d=>{this.showAtlasGrid=d.target.checked,this.drawOverlay();const h=this.container.querySelector("#fc-status");h.textContent=this.showAtlasGrid?"Atlas grid ON":"Atlas grid OFF"});const o=this.container.querySelector(".fc-copy-btn");o.addEventListener("click",()=>{this.copyToClipboard(),o.classList.remove("wiggle"),o.offsetWidth,o.classList.add("wiggle")}),o.addEventListener("animationend",()=>o.classList.remove("wiggle")),this.container.querySelector(".fc-reset-btn").addEventListener("click",()=>this.resetToDefaults()),this.container.querySelector(".fc-save-btn").addEventListener("click",()=>this.promptSavePreset()),this.setupPresetHandlers();const a=this.container.querySelector("#fc-bpm"),t=[40,60,66,72,76,80,84,88,92,96,100,104,108,112,116,120,126,132,138,144,152,160,168,176,184,192,200,208,216,224,232,240,252,264,276,288,300],s=d=>{const h=Math.max(30,Math.min(300,d));a.value=String(h),this.previewBpm=h};a.addEventListener("input",()=>{const d=parseInt(a.value);d>=30&&d<=300&&(this.previewBpm=d)}),this.container.querySelector(".fc-bpm-up").addEventListener("click",()=>{const d=this.previewBpm,h=t.find(f=>f>d)??300;s(h)}),this.container.querySelector(".fc-bpm-down").addEventListener("click",()=>{const d=this.previewBpm,h=[...t].reverse().find(f=>f<d)??40;s(h)});let c=0,n=0;a.addEventListener("mousedown",d=>{if(d.button!==0)return;c=d.clientY,n=this.previewBpm,a.style.cursor="ns-resize";const h=u=>{const y=c-u.clientY;s(n+Math.round(y/3))},f=()=>{a.style.cursor="",window.removeEventListener("mousemove",h),window.removeEventListener("mouseup",f)};window.addEventListener("mousemove",h),window.addEventListener("mouseup",f)});const r=this.container.querySelector("#fc-preview-scale");r.addEventListener("input",()=>{this.previewScale=parseInt(r.value)/100}),this.container.querySelectorAll(".fc-palette-btn").forEach(d=>{d.addEventListener("click",()=>{const h=parseInt(d.dataset.idx);this.setPalette(h),this.container.querySelectorAll(".fc-palette-btn").forEach(f=>f.classList.remove("active")),d.classList.add("active")})});const l=this.container.querySelector(".fc-modifier-btn");l&&l.addEventListener("click",()=>{this.modifierActive=!this.modifierActive,l.classList.toggle("active",this.modifierActive);const d=this.container.querySelector("#fc-status");this.modifierActive?d.textContent="Mod ON: Tap to place, drag orbit for skew/spread":d.textContent="Hold to place anchor"}),this.setupLocusInteractions()}setupLocusInteractions(){const i=this.locusCanvas,e=c=>{const n=i.getBoundingClientRect(),r=n.width/n.height,l=1;let d,h,f,u;return r>l?(h=n.height,d=n.height*l,f=(n.width-d)/2,u=0):(d=n.width,h=n.width/l,f=0,u=(n.height-h)/2),{x:(c.clientX-n.left-f)*k/d,y:(c.clientY-n.top-u)*k/h}},o=(c,n)=>{let l=null;for(const h of B){const f=this.anchorKey(this.selectedDegree,h.id),u=this.anchors.get(f);if(!u||u.familyIdx!==this.selectedFamily)continue;const y=u.orbitRadius,b=Math.cos(u.orbitRotation),p=Math.sin(u.orbitRotation);for(let g=0;g<4;g++){const x=g===1||g===3?y*u.orbitSkew:y,w=g*u.beatSpread,I=x*Math.cos(w),S=x*Math.sin(w),C=I*b-S*p,R=I*p+S*b,L=this.cToPixel(u.real+C,u.imag+R),D=Math.hypot(c-L.x,n-L.y);D<14&&(!l||D<l.dist)&&(l={dist:D,deg:this.selectedDegree,quality:h.id,orbitIdx:g})}}if(l)return{type:"orbit",deg:l.deg,quality:l.quality,orbitIdx:l.orbitIdx};let d=null;for(const h of B){const f=this.anchorKey(this.selectedDegree,h.id),u=this.anchors.get(f);if(!u||u.familyIdx!==this.selectedFamily)continue;const y=this.cToPixel(u.real,u.imag),b=Math.hypot(c-y.x,n-y.y);b<14&&(!d||b<d.dist)&&(d={dist:b,deg:this.selectedDegree,quality:h.id})}return d?{type:"center",deg:d.deg,quality:d.quality}:{type:"empty",deg:-1,quality:"",orbitIdx:-1}};i.addEventListener("mousedown",c=>{if(c.button!==0)return;const n=e(c),r=o(n.x,n.y);if(this.dragStartMx=c.clientX,this.dragStartMy=c.clientY,this.isDragging=!1,r.type==="orbit"){r.quality!==this.selectedQuality&&this.selectDegreeQuality(r.deg,r.quality),this.dragMode="orbit",this.dragDeg=r.deg;const l=this.anchorKey(r.deg,r.quality),d=this.anchors.get(l),h=r.orbitIdx*d.beatSpread,u=r.orbitIdx===1||r.orbitIdx===3?d.orbitRadius*d.orbitSkew:d.orbitRadius,y=u*Math.cos(h),b=u*Math.sin(h),p=Math.cos(d.orbitRotation),g=Math.sin(d.orbitRotation),v=y*p-b*g,x=y*g+b*p;this.dragStartData={origRadius:d.orbitRadius,origRotation:d.orbitRotation,origSkew:d.orbitSkew,origSpread:d.beatSpread,beatAngle:h,startOffsetR:v,startOffsetI:x},this.isDragging=!0,i.style.cursor="move"}else if(r.type==="center"){r.quality!==this.selectedQuality&&this.selectDegreeQuality(r.deg,r.quality),this.dragMode="center",this.dragDeg=r.deg;const l=this.anchorKey(r.deg,r.quality),d=this.anchors.get(l);this.dragStartData={real:d.real,imag:d.imag},i.style.cursor="move"}else{this.dragMode="pan";const l=this.viewBounds[this.selectedFamily];this.dragStartData={rMin:l.rMin,rMax:l.rMax,iMin:l.iMin,iMax:l.iMax},i.style.cursor="grabbing"}}),window.addEventListener("mousemove",c=>{if(this.dragMode===null)return;const n=i.getBoundingClientRect(),r=this.viewBounds[this.selectedFamily],l=c.clientX-this.dragStartMx,d=c.clientY-this.dragStartMy;if((Math.abs(l)>3||Math.abs(d)>3)&&(this.isDragging=!0),!this.isDragging)return;const h=n.width/n.height;let f,u;h>1?(u=n.height,f=n.height):(f=n.width,u=n.width);const y=l*(r.rMax-r.rMin)/f,b=d*(r.iMax-r.iMin)/u,p=this.anchorKey(this.dragDeg,this.selectedQuality),g=this.anchors.get(p);if(this.dragMode==="orbit"&&(g==null?void 0:g.familyIdx)===this.selectedFamily){const v=this.dragStartData.startOffsetR+y,x=this.dragStartData.startOffsetI+b,w=Math.sqrt(v*v+x*x),I=Math.atan2(x,v);if(this.snapMode=c.shiftKey?"cross":"none",c.ctrlKey||c.metaKey){const C=this.dragStartData.origSkew+b*3;g.orbitSkew=Math.max(.2,Math.min(2,C));const R=4,L=this.dragStartData.origSpread+y*R;g.beatSpread=Math.max(.1,Math.min(2,L)),g.orbitRadius=Math.max(.01,w)}else{const S=I-this.dragStartData.beatAngle;g.orbitRadius=Math.max(.01,w),g.orbitRotation=S}this.debouncedDraw()}else if(this.dragMode==="center"&&(g==null?void 0:g.familyIdx)===this.selectedFamily)g.real=this.dragStartData.real+y,g.imag=this.dragStartData.imag+b,this.debouncedDraw();else if(this.dragMode==="pan"){const v=-l*(this.dragStartData.rMax-this.dragStartData.rMin)/n.width,x=-d*(this.dragStartData.iMax-this.dragStartData.iMin)/n.height;r.rMin=this.dragStartData.rMin+v,r.rMax=this.dragStartData.rMax+v,r.iMin=this.dragStartData.iMin+x,r.iMax=this.dragStartData.iMax+x,this.debouncedDrawWithRender()}}),window.addEventListener("mouseup",c=>{if(this.dragMode!==null){if(i.style.cursor="crosshair",!this.isDragging&&this.dragMode!=="orbit"){if(this.dragMode==="center"){const n=this.anchorKey(this.dragDeg,this.selectedQuality),r=this.anchors.get(n);r&&this.startPreview(r)}else if(c.ctrlKey||c.metaKey){const n=e(c),r=this.pixelToC(n.x,n.y),l=this.currentAnchor;this.anchors.set(this.currentKey,{familyIdx:this.selectedFamily,real:r.r,imag:r.i,orbitRadius:(l==null?void 0:l.orbitRadius)??_,orbitSkew:(l==null?void 0:l.orbitSkew)??F,orbitRotation:(l==null?void 0:l.orbitRotation)??O,beatSpread:(l==null?void 0:l.beatSpread)??$}),this.startPreview(this.anchors.get(this.currentKey)),this.drawOverlay(),this.updateAssignments()}}else if(this.dragMode==="center"||this.dragMode==="orbit"){const n=this.anchorKey(this.dragDeg,this.selectedQuality),r=this.anchors.get(n);r&&this.startPreview(r),this.syncOrbitSliders()}this.dragMode==="center"&&this.debouncedThumbnailUpdate(),this.dragMode=null,this.isDragging=!1,this.snapMode="none",this.drawOverlay()}}),i.addEventListener("wheel",c=>{if(!c.ctrlKey)return;c.preventDefault();const n=e(c),r=this.pixelToC(n.x,n.y),l=this.viewBounds[this.selectedFamily],d=c.deltaY<0?.7:1.4,h=(l.rMax-l.rMin)*d,f=(l.iMax-l.iMin)*d,u=n.x/k,y=n.y/k;l.rMin=r.r-u*h,l.rMax=r.r+(1-u)*h,l.iMin=r.i-y*f,l.iMax=r.i+(1-y)*f;const b=T[this.selectedFamily].bounds,p=b.rMax-b.rMin;this.zoomLevels[this.selectedFamily]=p/(l.rMax-l.rMin),this.drawScaledPreview(),this.drawOverlayMarkers(),this.zoomDebounceTimer!==null&&clearTimeout(this.zoomDebounceTimer),this.zoomDebounceTimer=window.setTimeout(()=>{this.zoomDebounceTimer=null,this.renderLocus(),this.drawOverlay()},150)},{passive:!1}),i.addEventListener("dblclick",()=>{this.viewBounds[this.selectedFamily]={...T[this.selectedFamily].bounds},this.zoomLevels[this.selectedFamily]=1,this.renderLocus(),this.drawOverlay()});const a=navigator.platform.includes("Mac")?"‚åò":"Ctrl";i.addEventListener("mousemove",c=>{if(this.dragMode)return;const n=e(c),r=this.pixelToC(n.x,n.y),l=this.container.querySelector("#fc-status");l.textContent=`${T[this.selectedFamily].label} | c = ${r.r.toFixed(4)} + ${r.i.toFixed(4)}i | ${a}+click=place`});const t=c=>{const n=i.getBoundingClientRect(),r=n.width/n.height,l=1;let d,h,f,u;return r>l?(h=n.height,d=n.height*l,f=(n.width-d)/2,u=0):(d=n.width,h=n.width/l,f=0,u=(n.height-h)/2),{x:(c.clientX-n.left-f)*k/d,y:(c.clientY-n.top-u)*k/h}},s=()=>{this.longPressTimer!==null&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.touchStartPos=null};i.addEventListener("touchstart",c=>{if(c.touches.length!==1){s();return}const n=c.touches[0],r=t(n),l=o(r.x,r.y);if(this.touchStartPos={x:n.clientX,y:n.clientY},l.type==="orbit"||l.type==="center"){if(s(),this.dragStartMx=n.clientX,this.dragStartMy=n.clientY,this.isDragging=!1,l.type==="orbit"){l.quality!==this.selectedQuality&&this.selectDegreeQuality(l.deg,l.quality),this.dragMode="orbit",this.dragDeg=l.deg;const f=this.anchorKey(l.deg,l.quality),u=this.anchors.get(f),y=l.orbitIdx*u.beatSpread,p=l.orbitIdx===1||l.orbitIdx===3?u.orbitRadius*u.orbitSkew:u.orbitRadius,g=p*Math.cos(y),v=p*Math.sin(y),x=Math.cos(u.orbitRotation),w=Math.sin(u.orbitRotation);this.dragStartData={origRadius:u.orbitRadius,origRotation:u.orbitRotation,origSkew:u.orbitSkew,origSpread:u.beatSpread,beatAngle:y,startOffsetR:g*x-v*w,startOffsetI:g*w+v*x},this.isDragging=!0}else{l.quality!==this.selectedQuality&&this.selectDegreeQuality(l.deg,l.quality),this.dragMode="center",this.dragDeg=l.deg;const f=this.anchorKey(l.deg,l.quality),u=this.anchors.get(f);this.dragStartData={real:u.real,imag:u.imag}}return}const d=this.container.querySelector("#fc-status"),h=()=>{navigator.vibrate&&navigator.vibrate(50);const f=this.pixelToC(r.x,r.y),u=this.currentAnchor;this.anchors.set(this.currentKey,{familyIdx:this.selectedFamily,real:f.r,imag:f.i,orbitRadius:(u==null?void 0:u.orbitRadius)??_,orbitSkew:(u==null?void 0:u.orbitSkew)??F,orbitRotation:(u==null?void 0:u.orbitRotation)??O,beatSpread:(u==null?void 0:u.beatSpread)??$}),d.textContent=`Anchor placed at c = ${f.r.toFixed(4)} + ${f.i.toFixed(4)}i`,this.startPreview(this.anchors.get(this.currentKey)),this.drawOverlay(),this.updateAssignments(),this.touchStartPos=null};this.modifierActive?h():(d.textContent="Hold to place anchor...",this.longPressTimer=window.setTimeout(()=>{this.longPressTimer=null,this.touchStartPos&&h()},P.LONG_PRESS_DURATION))},{passive:!0}),i.addEventListener("touchmove",c=>{if(this.dragMode&&c.touches.length===1){const n=c.touches[0],r=i.getBoundingClientRect(),l=this.viewBounds[this.selectedFamily],d=n.clientX-this.dragStartMx,h=n.clientY-this.dragStartMy;if((Math.abs(d)>3||Math.abs(h)>3)&&(this.isDragging=!0),!this.isDragging)return;const f=r.width/r.height;let u,y;f>1?(y=r.height,u=r.height):(u=r.width,y=r.width);const b=d*(l.rMax-l.rMin)/u,p=h*(l.iMax-l.iMin)/y,g=this.anchorKey(this.dragDeg,this.selectedQuality),v=this.anchors.get(g);if(this.dragMode==="orbit"&&(v==null?void 0:v.familyIdx)===this.selectedFamily){const x=this.dragStartData.startOffsetR+b,w=this.dragStartData.startOffsetI+p,I=Math.sqrt(x*x+w*w);if(this.modifierActive){const C=this.dragStartData.origSkew+p*3;v.orbitSkew=Math.max(.2,Math.min(2,C));const R=4,L=this.dragStartData.origSpread+b*R;v.beatSpread=Math.max(.1,Math.min(2,L)),v.orbitRadius=Math.max(.01,I)}else{const C=Math.atan2(w,x)-this.dragStartData.beatAngle;v.orbitRadius=Math.max(.01,I),v.orbitRotation=C}this.debouncedDraw()}else this.dragMode==="center"&&(v==null?void 0:v.familyIdx)===this.selectedFamily&&(v.real=this.dragStartData.real+b,v.imag=this.dragStartData.imag+p,this.debouncedDraw());return}if(this.touchStartPos&&c.touches.length===1){const n=c.touches[0],r=n.clientX-this.touchStartPos.x,l=n.clientY-this.touchStartPos.y;if(Math.abs(r)>P.TOUCH_MOVE_THRESHOLD||Math.abs(l)>P.TOUCH_MOVE_THRESHOLD){s();const d=this.container.querySelector("#fc-status");d.textContent="Hold to place anchor"}}},{passive:!0}),i.addEventListener("touchend",()=>{if(s(),this.dragMode==="center"||this.dragMode==="orbit"){const n=this.anchorKey(this.dragDeg,this.selectedQuality),r=this.anchors.get(n);r&&this.startPreview(r),this.syncOrbitSliders(),this.dragMode==="center"&&this.debouncedThumbnailUpdate()}this.dragMode=null,this.isDragging=!1,this.drawOverlay();const c=this.container.querySelector("#fc-status");c.textContent="Hold to place anchor"},{passive:!0}),i.addEventListener("touchcancel",()=>{s(),this.dragMode=null,this.isDragging=!1},{passive:!0})}cToPixel(i,e){const o=this.viewBounds[this.selectedFamily];return{x:(i-o.rMin)/(o.rMax-o.rMin)*k,y:(e-o.iMin)/(o.iMax-o.iMin)*k}}pixelToC(i,e){const o=this.viewBounds[this.selectedFamily];return{r:o.rMin+i/k*(o.rMax-o.rMin),i:o.iMin+e/k*(o.iMax-o.iMin)}}selectDegreeQuality(i,e){this.selectedDegree=i,this.selectedQuality=e,this.container.querySelectorAll(".fc-grid-cell").forEach(a=>{const t=a,s=parseInt(t.dataset.deg),c=t.dataset.quality;a.classList.toggle("active",s===i&&c===e)});const o=this.currentAnchor;o?(this.selectedFamily=o.familyIdx,this.updateFamilyUI(),this.renderLocus(),this.startPreview(o)):this.stopPreview(),this.drawOverlay(),this.updateAssignments()}copyToClipboard(){const i=[];i.push("// Fractal anchor preset"),i.push("{"),i.push("  id: 'new-preset',"),i.push("  name: 'New Preset',"),i.push("  builtIn: true,"),i.push("  anchors: {");for(let o=0;o<=7;o++){const a=this.anchorKey(o,"major"),t=this.anchors.get(a);if(!t)continue;const s=T[t.familyIdx];i.push(`    ${o}: { real: ${t.real.toFixed(4)}, imag: ${t.imag.toFixed(4)}, type: ${s.typeNum}, orbitRadius: ${t.orbitRadius.toFixed(4)}, orbitSkew: ${t.orbitSkew.toFixed(2)}, orbitRotation: ${t.orbitRotation.toFixed(2)}, beatSpread: ${t.beatSpread.toFixed(2)} },`)}i.push("  },"),i.push("},");const e=i.join(`
`);navigator.clipboard.writeText(e).then(()=>{const o=this.container.querySelector("#fc-status");o.textContent="Copied to clipboard!",setTimeout(()=>{const a="ontouchstart"in window;o.textContent=a?"Hold to place anchor":"Ctrl+click to place anchor"},2e3)}).catch(o=>{console.error("Failed to copy:",o);const a=this.container.querySelector("#fc-status");a.textContent="Failed to copy - check console"})}applyToAllQualities(i){const e=this.currentAnchor;if(!e){console.log("No anchor to copy from current selection");return}for(const o of B){const a=this.anchorKey(i,o.id);this.anchors.set(a,{familyIdx:e.familyIdx,real:e.real,imag:e.imag,orbitRadius:e.orbitRadius,orbitSkew:e.orbitSkew,orbitRotation:e.orbitRotation,beatSpread:e.beatSpread})}this.container.querySelectorAll(".fc-grid-degree").forEach(o=>{const a=o;parseInt(a.dataset.deg)===i&&(a.classList.add("applied"),setTimeout(()=>a.classList.remove("applied"),300))}),this.drawOverlay(),this.updateAssignments()}buildPaletteLUT(){const e=tt[this.paletteIdx].stops;for(let o=0;o<K;o++){const a=o/(K-1);let t=e[0],s=e[e.length-1];for(let l=0;l<e.length-1;l++)if(a>=e[l].pos&&a<=e[l+1].pos){t=e[l],s=e[l+1];break}const c=s.pos-t.pos,n=c===0?0:(a-t.pos)/c,r=o*3;this.paletteLUT[r]=Math.round(t.color[0]+(s.color[0]-t.color[0])*n),this.paletteLUT[r+1]=Math.round(t.color[1]+(s.color[1]-t.color[1])*n),this.paletteLUT[r+2]=Math.round(t.color[2]+(s.color[2]-t.color[2])*n)}}setPalette(i){this.paletteIdx=i,this.buildPaletteLUT()}loadAnchors(){this.markAllThumbnailsDirty();const i=at();if(i)for(let e=0;e<=7;e++){const o=i[e];if(o){const a=U[o.type];if(a!==void 0){const t={familyIdx:a,real:o.real,imag:o.imag,orbitRadius:o.orbitRadius??_,orbitSkew:o.orbitSkew??F,orbitRotation:o.orbitRotation??O,beatSpread:o.beatSpread??$};for(const s of B)this.anchors.set(this.anchorKey(e,s.id),{familyIdx:t.familyIdx,real:t.real,imag:t.imag,orbitRadius:t.orbitRadius,orbitSkew:t.orbitSkew,orbitRotation:t.orbitRotation,beatSpread:t.beatSpread})}}}else{this.resetToDefaults();return}this.syncOrbitSliders(),this.updateResetButtonState()}resetToDefaults(){this.anchors.clear(),this.markAllThumbnailsDirty();for(let i=0;i<T.length;i++)this.viewBounds[i]={...T[i].bounds},this.renderedBounds[i]={...T[i].bounds},this.zoomLevels[i]=1;for(let i=0;i<=7;i++){const e=Q[i],a={familyIdx:U[e.type],real:e.real,imag:e.imag,orbitRadius:e.orbitRadius,orbitSkew:e.orbitSkew??F,orbitRotation:e.orbitRotation??O,beatSpread:e.beatSpread??$};for(const t of B)this.anchors.set(this.anchorKey(i,t.id),{familyIdx:a.familyIdx,real:a.real,imag:a.imag,orbitRadius:a.orbitRadius,orbitSkew:a.orbitSkew,orbitRotation:a.orbitRotation,beatSpread:a.beatSpread})}this.syncOrbitSliders(),this.renderLocus(),this.drawOverlay(),this.updateAssignments(),this.updateResetButtonState(),this.selectDegreeQuality(1,"major")}anchorsMatchDefaults(){for(let i=0;i<=7;i++){const e=this.anchorKey(i,"major"),o=this.anchors.get(e),a=Q[i];if(!o)return!1;const t=U[a.type],s=.001;if(o.familyIdx!==t||Math.abs(o.real-a.real)>s||Math.abs(o.imag-a.imag)>s||Math.abs(o.orbitRadius-a.orbitRadius)>s||Math.abs(o.orbitSkew-(a.orbitSkew??F))>s||Math.abs(o.orbitRotation-(a.orbitRotation??O))>s||Math.abs(o.beatSpread-(a.beatSpread??$))>s)return!1}return!0}updateResetButtonState(){const i=this.anchorsMatchDefaults(),e=this.container.querySelector(".fc-reset-btn"),o=this.container.querySelector(".fc-save-btn"),a=this.container.querySelector(".fc-copy-btn");e&&(e.disabled=i),o&&(o.disabled=i),a&&(a.disabled=i)}getLocusCacheKey(){const i=this.viewBounds[this.selectedFamily];return`${this.selectedFamily}:${i.rMin.toFixed(2)}:${i.rMax.toFixed(2)}:${i.iMin.toFixed(2)}:${i.iMax.toFixed(2)}`}renderLocus(){const i=this.getLocusCacheKey(),e=this.locusCache.get(i);if(e){this.locusBuffer.getContext("2d").drawImage(e,0,0);return}const o=T[this.selectedFamily],a=this.viewBounds[this.selectedFamily],t=this.locusBuffer.getContext("2d"),s=t.createImageData(k,k),c=s.data,n=(a.rMax-a.rMin)/k,r=(a.iMax-a.iMin)/k,l=Math.round(rt*(1+Math.log2(Math.max(1,this.zoomLevels[this.selectedFamily]))));for(let h=0;h<k;h++){const f=a.iMin+h*r;for(let u=0;u<k;u++){const y=a.rMin+u*n,b=o.locus(y,f,l),p=(h*k+u)*4;if(b===0)c[p]=8,c[p+1]=8,c[p+2]=16;else{const g=Math.sqrt(b/l);c[p]=Math.round(12+g*50),c[p+1]=Math.round(20+g*100),c[p+2]=Math.round(35+g*80)}c[p+3]=255}}t.putImageData(s,0,0);const d=document.createElement("canvas");if(d.width=k,d.height=k,d.getContext("2d").drawImage(this.locusBuffer,0,0),this.locusCache.set(i,d),this.locusCache.size>20){const h=this.locusCache.keys().next().value;h&&this.locusCache.delete(h)}this.renderedBounds[this.selectedFamily]={...this.viewBounds[this.selectedFamily]}}drawScaledPreview(){const i=this.viewBounds[this.selectedFamily],e=this.renderedBounds[this.selectedFamily],o=(i.rMin-e.rMin)/(e.rMax-e.rMin)*k,a=(i.iMin-e.iMin)/(e.iMax-e.iMin)*k,t=(i.rMax-i.rMin)/(e.rMax-e.rMin)*k,s=(i.iMax-i.iMin)/(e.iMax-e.iMin)*k;this.locusCtx.imageSmoothingEnabled=!0,this.locusCtx.imageSmoothingQuality="low",this.locusCtx.fillStyle="#081020",this.locusCtx.fillRect(0,0,k,k),this.locusCtx.drawImage(this.locusBuffer,o,a,t,s,0,0,k,k)}drawOverlay(){this.locusCtx.drawImage(this.locusBuffer,0,0),this.drawOverlayMarkers()}debouncedDraw(){this.dragDebounceTimer!==null&&cancelAnimationFrame(this.dragDebounceTimer),this.dragDebounceTimer=requestAnimationFrame(()=>{this.dragDebounceTimer=null,this.drawOverlay(),this.syncOrbitSliders(),this.updateResetButtonState()})}debouncedDrawWithRender(){this.dragDebounceTimer!==null&&cancelAnimationFrame(this.dragDebounceTimer),this.drawScaledPreview(),this.drawOverlayMarkers(),this.zoomDebounceTimer!==null&&clearTimeout(this.zoomDebounceTimer),this.zoomDebounceTimer=window.setTimeout(()=>{this.zoomDebounceTimer=null,this.renderLocus(),this.drawOverlay()},100)}drawOverlayMarkers(){if(this.showAtlasGrid){const o=k/8,a=this.viewBounds[this.selectedFamily],t=T[this.selectedFamily],[s,c,n]=this.parseHexColor(N[this.selectedDegree]);for(let r=0;r<8;r++)for(let l=0;l<8;l++){const d=a.rMin+(l+.5)/8*(a.rMax-a.rMin),h=a.iMin+(r+.5)/8*(a.iMax-a.iMin),f=32,u=document.createElement("canvas");u.width=f,u.height=f;const y=u.getContext("2d"),b=y.createImageData(f,f),p=b.data,g=3.6,v=g/2,x=g/f,w=40;for(let C=0;C<f;C++)for(let R=0;R<f;R++){const L=-v+R*x,D=-v+C*x,q=t.julia(L,D,d,h,w),A=(C*f+R)*4;if(q===0)p[A]=p[A+1]=p[A+2]=0;else{const z=Math.sqrt(q/w);p[A]=Math.min(255,Math.round(z*s)),p[A+1]=Math.min(255,Math.round(z*c)),p[A+2]=Math.min(255,Math.round(z*n))}p[A+3]=200}y.putImageData(b,0,0);const I=l*o,S=r*o;this.locusCtx.drawImage(u,I,S,o,o),this.locusCtx.strokeStyle="rgba(255, 255, 255, 0.2)",this.locusCtx.strokeRect(I,S,o,o)}}if(this.dragMode==="orbit"&&this.snapMode==="cross"){const e=this.anchorKey(this.dragDeg,this.selectedQuality),o=this.anchors.get(e);if(o){const a=this.cToPixel(o.real,o.imag);this.locusCtx.save(),this.locusCtx.setLineDash([4,4]),this.locusCtx.strokeStyle="rgba(255, 255, 255, 0.4)",this.locusCtx.lineWidth=1,this.locusCtx.beginPath(),this.locusCtx.moveTo(0,a.y),this.locusCtx.lineTo(k,a.y),this.locusCtx.moveTo(a.x,0),this.locusCtx.lineTo(a.x,k),this.locusCtx.stroke(),this.locusCtx.restore()}}const i=["#888888","#ff6666","#ffaa44","#ffff66","#66ff66","#66ffff","#6688ff","#ff66ff"];for(let e=0;e<2;e++)for(let o=1;o<=7;o++)for(const a of B){const t=this.anchorKey(o,a.id),s=this.anchors.get(t);if(!s||s.familyIdx!==this.selectedFamily)continue;const c=o===this.selectedDegree,n=a.id===this.selectedQuality,r=c&&n;if(e===0&&r||e===1&&!r)continue;const l=this.cToPixel(s.real,s.imag),d=i[o],h=c?n?1:.7:.3,f=s.orbitRadius,u=Math.cos(s.orbitRotation),y=Math.sin(s.orbitRotation);if(this.locusCtx.globalAlpha=h,c)for(let p=0;p<4;p++){const v=p===1||p===3?f*s.orbitSkew:f,x=p*s.beatSpread,w=v*Math.cos(x),I=v*Math.sin(x),S=w*u-I*y,C=w*y+I*u,R=this.cToPixel(s.real+S,s.imag+C);this.locusCtx.beginPath(),this.locusCtx.moveTo(l.x,l.y),this.locusCtx.lineTo(R.x,R.y),this.locusCtx.strokeStyle=G[p],this.locusCtx.lineWidth=r?1.5:1,this.locusCtx.stroke(),this.locusCtx.beginPath(),this.locusCtx.arc(R.x,R.y,r?5:3,0,j),this.locusCtx.fillStyle=G[p],this.locusCtx.fill(),r&&(this.locusCtx.globalAlpha=1,this.locusCtx.font="bold 9px monospace",this.locusCtx.lineWidth=2,this.locusCtx.strokeStyle="#000",this.locusCtx.strokeText(J[p],R.x+6,R.y-4),this.locusCtx.fillStyle=G[p],this.locusCtx.fillText(J[p],R.x+6,R.y-4),this.locusCtx.globalAlpha=h)}this.locusCtx.beginPath(),this.locusCtx.arc(l.x,l.y,r?7:c?5:4,0,j),this.locusCtx.fillStyle=d,this.locusCtx.fill(),r&&(this.locusCtx.globalAlpha=1,this.locusCtx.strokeStyle="#fff",this.locusCtx.lineWidth=2,this.locusCtx.stroke()),this.locusCtx.globalAlpha=1,this.locusCtx.font=r?"bold 11px monospace":"9px monospace",this.locusCtx.lineWidth=3,this.locusCtx.strokeStyle="#000";const b=`${o}${a.label}`;this.locusCtx.strokeText(b,l.x+8,l.y-6),this.locusCtx.fillStyle=d,this.locusCtx.fillText(b,l.x+8,l.y-6)}this.locusCtx.globalAlpha=1}updateAssignments(){const i=this.container.querySelector("#fc-assignments");let e="";for(let o=1;o<=7;o++){const a=this.anchorKey(o,this.selectedQuality),t=this.anchors.get(a);e+=`<div class="fc-assign-row">
        <span class="fc-deg-dot" style="background:${N[o]}"></span>
        <strong>${W[o]}</strong>
        ${t?`<span class="fc-type-tag">${T[t.familyIdx].label}</span>`:'<span class="fc-unassigned">‚Äî</span>'}
      </div>`}i.innerHTML=e,this.updateGridStates()}updateGridStates(){this.container.querySelectorAll(".fc-grid-cell").forEach(i=>{const e=i,o=parseInt(e.dataset.deg),a=e.dataset.quality,t=this.anchorKey(o,a),s=this.anchors.get(t),c=!!s;e.classList.toggle("has-anchor",c);let n=e.querySelector("canvas");if(n||(n=document.createElement("canvas"),n.width=P.THUMB_SIZE,n.height=P.THUMB_SIZE,n.className="fc-cell-thumb",e.innerHTML="",e.appendChild(n)),s){const r=this.getOrRenderThumbnail(s,o);n.getContext("2d").putImageData(r,0,0),n.style.opacity="1"}else{const r=n.getContext("2d");r.fillStyle="#111",r.fillRect(0,0,P.THUMB_SIZE,P.THUMB_SIZE),n.style.opacity="0.3"}})}markAllThumbnailsDirty(){this.thumbnailCache.clear()}debouncedThumbnailUpdate(){this.thumbnailDebounceTimer!==null&&clearTimeout(this.thumbnailDebounceTimer),this.thumbnailDebounceTimer=window.setTimeout(()=>{this.thumbnailDebounceTimer=null,this.markAllThumbnailsDirty(),this.updateAssignments()},1e3)}getThumbnailKey(i,e){const o=i.real.toFixed(3),a=i.imag.toFixed(3);return`${e}:${i.familyIdx}:${o}:${a}`}parseHexColor(i){const e=i.replace("#","");return e.length===3?[parseInt(e[0]+e[0],16),parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16)]:[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}getOrRenderThumbnail(i,e){const o=this.getThumbnailKey(i,e);let a=this.thumbnailCache.get(o);if(a)return a;const[t,s,c]=this.parseHexColor(N[e]||"#888888"),n=P.THUMB_SIZE,r=n*2,l=P.THUMB_ITER,d=T[i.familyIdx],h=3.6,f=h/2,u=h/r,y=new Float32Array(r*r*3);for(let p=0;p<r;p++)for(let g=0;g<r;g++){const v=-f+g*u,x=-f+p*u,w=d.julia(v,x,i.real,i.imag,l),I=(p*r+g)*3;if(w===0)y[I]=y[I+1]=y[I+2]=0;else{const S=Math.sqrt(w/l);y[I]=S*t,y[I+1]=S*s,y[I+2]=S*c}}const b=new Uint8ClampedArray(n*n*4);for(let p=0;p<n;p++)for(let g=0;g<n;g++){const v=g*2,x=p*2;let w=0,I=0,S=0;for(let R=0;R<2;R++)for(let L=0;L<2;L++){const D=((x+R)*r+(v+L))*3;w+=y[D],I+=y[D+1],S+=y[D+2]}const C=(p*n+g)*4;b[C]=Math.min(255,Math.round(w/4)),b[C+1]=Math.min(255,Math.round(I/4)),b[C+2]=Math.min(255,Math.round(S/4)),b[C+3]=255}if(a=new ImageData(b,n,n),this.thumbnailCache.set(o,a),this.thumbnailCache.size>200){const p=this.thumbnailCache.keys().next().value;p&&this.thumbnailCache.delete(p)}return a}startPreview(i){this.stopPreview(),this.previewPhase=0,this.previewLastTime=0;let e=0;const o=a=>{if(e++,e%3!==0){this.previewAnim=requestAnimationFrame(o);return}const t=this.previewLastTime===0?.05:Math.min((a-this.previewLastTime)/1e3,.1);this.previewLastTime=a;const s=60/this.previewBpm;this.previewPhase+=t;const c=this.previewPhase/s,n=c-Math.floor(c),r=Math.sin(Math.PI*n),l=Math.floor(c)%4,d=l===1||l===3,h=i.orbitRadius*this.previewScale,f=d?h*i.orbitSkew:h,u=l*i.beatSpread,y=f*Math.cos(u)*r,b=f*Math.sin(u)*r,p=Math.cos(i.orbitRotation),g=Math.sin(i.orbitRotation),v=i.real+y*p-b*g,x=i.imag+y*g+b*p;this.renderJulia(i.familyIdx,v,x),this.previewAnim=requestAnimationFrame(o)};this.previewAnim=requestAnimationFrame(o)}stopPreview(){this.previewAnim&&(cancelAnimationFrame(this.previewAnim),this.previewAnim=null)}renderJulia(i,e,o){const a=T[i],t=this.juliaCtx.createImageData(E,E),s=t.data,c=3.6,n=c/2,r=c/E,l=this.paletteLUT;for(let h=0;h<E;h++)for(let f=0;f<E;f++){const u=-n+f*r,y=-n+h*r,b=a.julia(u,y,e,o,V),p=(h*E+f)*4;if(b===0)s[p]=s[p+1]=s[p+2]=0;else{const g=Math.sqrt(b/V),v=Math.min(K-1,Math.round(g*(K-1)))*3;s[p]=l[v],s[p+1]=l[v+1],s[p+2]=l[v+2]}s[p+3]=255}this.juliaCtx.putImageData(t,0,0);const d=this.container.querySelector("#fc-julia-info");d.textContent=`${a.label} | c = ${e.toFixed(4)} + ${o.toFixed(4)}i`}show(){this.visible=!0,this.container.classList.add("visible"),document.body.style.overflow="hidden",this.loadAnchors(),this.renderLocus(),this.drawOverlay(),this.updateAssignments();const i=this.currentAnchor;i&&this.startPreview(i)}hide(){this.visible=!1,this.container.classList.add("dismissing"),setTimeout(()=>{this.container.classList.remove("visible","dismissing")},250),document.body.style.overflow="",this.stopPreview()}toggle(){this.visible?this.hide():this.show()}isVisible(){return this.visible}};M(P,"LONG_PRESS_DURATION",400),M(P,"TOUCH_MOVE_THRESHOLD",10),M(P,"THUMB_SIZE",94),M(P,"THUMB_ITER",60);let et=P;export{et as FractalConfigPanel,nt as loadUserPresets};
